# ============================================
# DBML ìžë™ ë™ê¸°í™” GitHub Actions Workflow
# JPA Entity ë³€ê²½ ì‹œ ìžë™ìœ¼ë¡œ DBML ìƒì„± ë° dbdocs ë°°í¬
# ============================================

name: DBML Sync

on:
  push:
    branches: [main, develop]
    paths:
      # Entity íŒŒì¼ ë³€ê²½ ì‹œì—ë§Œ íŠ¸ë¦¬ê±°
      - 'src/main/java/**/entity/**/*.java'
      - 'src/main/java/**/domain/**/*Entity.java'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  generate-and-deploy-dbml:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. JDK ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 3. Gradle ê¶Œí•œ ì„¤ì •
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. DBML íŒŒì¼ ìƒì„±
      - name: Generate DBML from JPA Entities
        run: ./gradlew generateDbml --no-daemon

      # 5. Node.js ì„¤ì • (dbdocs CLIìš©)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 6. dbdocs CLI ì„¤ì¹˜
      - name: Install dbdocs CLI
        run: npm install -g dbdocs

      # 7. dbdocsì— ë°°í¬
      - name: Deploy to dbdocs
        env:
          DBDOCS_TOKEN: ${{ secrets.DBDOCS_TOKEN }}
        run: |
          dbdocs build database/schema_generated.dbml \
            --project my-shop-front \
            --token $DBDOCS_TOKEN

      # 8. ìƒì„±ëœ DBML íŒŒì¼ ì»¤ë°‹ (ì„ íƒì )
      - name: Commit generated DBML
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add database/schema_generated.dbml
          git diff --staged --quiet || git commit -m "chore: auto-generated DBML from JPA entities [skip ci]"
          git push
        continue-on-error: true

      # 9. ê²°ê³¼ ìš”ì•½
      - name: Summary
        run: |
          echo "## ðŸ“ DBML ë™ê¸°í™” ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ DBML íŒŒì¼ì´ JPA Entityë¡œë¶€í„° ìžë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ dbdocs.ioì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ERD í™•ì¸:** [https://dbdocs.io/your-username/my-shop-front](https://dbdocs.io/your-username/my-shop-front)" >> $GITHUB_STEP_SUMMARY
